@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@using FM.Application.Services
@using Blazored.LocalStorage
@using Microsoft.JSInterop
@using System.Text.Json
@implements IDisposable
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject ILocalStorageService LocalStorage
@inject IJSRuntime JSRuntime

<div class="homepage-container">
	<div class="header">
		<div class="logo">
			<img src="images/ApolloFM.png" alt="ApolloFM Logo" class="logo-image" />
		</div>
	</div>

	<div class="content-container">
		<h1 class="title">Welcome to ApolloFM</h1>
		<p class="intro-text">Connect your Spotify Account to get started.</p>

		@if (isLoading)
		{
			<div class="spinner-container">
				<div class="spinner-border text-light" role="status">
					<span class="visually-hidden">Loading...</span>
				</div>
			</div>
		}
		else if (!isLoggedIn)
		{
			<button class="btn-spotify" @onclick="Login">
				<i class="fab fa-spotify me-2"></i> Connect with Spotify
			</button>

			@if (authError)
			{
				<div class="error-message">
					@errorMessage
				</div>
			}
		}
		else
		{
			<p class="welcome-text">Welcome back, <strong class="user-name">@(string.IsNullOrEmpty(userName) ? "Spotify User" : userName)</strong>!</p>
			<button class="btn-primary dashboard-btn" @onclick="GoToDashboard">
				<i class="fas fa-chart-line me-1"></i> Go to Dashboard
			</button>
			<button class="logout-btn" @onclick="Logout">
				<i class="fas fa-sign-out-alt me-1"></i> Logout
			</button>
		}
	</div>
</div>

@code {

	private bool isLoggedIn = false;
	private string? userName;
	private bool isLoading = true;
	private bool authError = false;
	private string errorMessage = "There was a problem authenticating with Spotify. Please try again.";

	protected override async Task OnInitializedAsync()
	{
		try
		{
			Console.WriteLine("Home: OnInitializedAsync started");

			// First check if we have a token in sessionStorage
			string token = null;

			try
			{
				token = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "spotify_access_token");
			}
			catch (Exception ex)
			{
				Console.WriteLine($"Error reading from sessionStorage: {ex.Message}");
			}

			if (!string.IsNullOrEmpty(token))
			{
				try
				{
					// Token exists, try to authenticate with it
					var authProvider = (SpotifyAuthenticationStateProvider)AuthStateProvider;
					await authProvider.MarkUserAsAuthenticated(token);
					Console.WriteLine("User authenticated with stored token");
				}
				catch (Exception ex)
				{
					Console.WriteLine($"Error authenticating with stored token: {ex.Message}");
				}
			}

			// Check if user is authenticated
			try
			{
				isLoggedIn = await AuthService.IsUserAuthenticated();
				Console.WriteLine($"User is authenticated: {isLoggedIn}");

				if (isLoggedIn)
				{
					try
					{
						var profile = await AuthService.GetUserProfile();
						userName = profile?.DisplayName ?? "Spotify User";
						Console.WriteLine($"Got user profile: {userName}");
					}
					catch (Exception ex)
					{
						Console.WriteLine($"Error getting profile: {ex.Message}");
						userName = "Spotify User";
					}
				}
			}
			catch (Exception ex)
			{
				Console.WriteLine($"Error checking authentication: {ex.Message}");
				isLoggedIn = false;
			}

			Console.WriteLine("Home: OnInitializedAsync completed");
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Unhandled error in OnInitializedAsync: {ex.Message}\n{ex.StackTrace}");
			authError = true;
			errorMessage = "Error during initialization. Please refresh the page and try again.";
		}
		finally
		{
			isLoading = false;
		}

		// Subscribe to the AuthenticationStateChanged event
		try
		{
			AuthStateProvider.AuthenticationStateChanged += AuthenticationStateChangedHandler;
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error subscribing to auth state changes: {ex.Message}");
		}
	}


	private async Task Login()
	{
		try
		{
			// DIREKTE IMPLEMENTERING - MEGET SIMPEL TILGANG
			Console.WriteLine("Attempting direct login with simplified approach");

			// API URL
			var apiUrl = "https://localhost:7043";

			// Redirect direkte til Spotify auth URL
			var clientId = "824cb0e5e1d549c683c642d9c9ae062b"; // Dit client ID
			var redirectUri = $"{apiUrl}/api/auth/handle-state-error";
			var scopes = "user-read-email user-read-private user-top-read user-read-currently-playing";

			var spotifyUrl = $"https://accounts.spotify.com/authorize" +
								$"?client_id={Uri.EscapeDataString(clientId)}" +
								$"&response_type=code" +
								$"&redirect_uri={Uri.EscapeDataString(redirectUri)}" +
								$"&scope={Uri.EscapeDataString(scopes)}";

			Console.WriteLine($"Direct Spotify Auth URL: {spotifyUrl}");
			await JSRuntime.InvokeVoidAsync("console.log", "Navigating directly to Spotify auth:", spotifyUrl);

			Navigation.NavigateTo(spotifyUrl, forceLoad: true);
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error during login: {ex.Message}");
			await JSRuntime.InvokeVoidAsync("console.error", "Login error:", ex.Message);
			authError = true;
			errorMessage = "Error during login. Please try again.";
			StateHasChanged();
		}
	}

	private async Task HandleSpotifyCallback(string code)
	{
		try
		{
			Console.WriteLine("Handling Spotify callback with code: " + code);

			// API URL
			var apiUrl = "https://localhost:7043/api/auth/handle-state-error";

			// Send kode til API for at få token
			var response = await JSRuntime.InvokeAsync<string>("fetch", $"{apiUrl}?code={Uri.EscapeDataString(code)}");
			var tokenResponse = JsonSerializer.Deserialize<TokenResponse>(response, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

			if (!string.IsNullOrEmpty(tokenResponse?.AccessToken))
			{
				// Gem token i localStorage
				await LocalStorage.SetItemAsync("spotify_access_token", tokenResponse.AccessToken);
				Console.WriteLine("Token stored in localStorage");

				// Opdater authentication state
				if (AuthStateProvider is SpotifyAuthenticationStateProvider spotifyAuth)
				{
					await spotifyAuth.MarkUserAsAuthenticated(tokenResponse.AccessToken);
					Console.WriteLine("Authentication state updated");
				}

				// Naviger til dashboard
				Navigation.NavigateTo("/dashboard");
			}
			else
			{
				Console.WriteLine("Failed to retrieve token from API");
				authError = true;
				errorMessage = "Failed to retrieve token from API";
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error handling Spotify callback: {ex.Message}");
			authError = true;
			errorMessage = "Error during authentication. Please try again.";
		}
	}

	private class TokenResponse
	{
		public string AccessToken { get; set; }
		public string RefreshToken { get; set; }
		public int ExpiresIn { get; set; }
	}

	private void GoToDashboard()
	{
		Navigation.NavigateTo("/dashboard");
	}

	private void Logout()
	{
		try
		{
			AuthService.Logout();
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error during logout: {ex.Message}");
			// Show error message or handle gracefully
		}
	}

	private async void AuthenticationStateChangedHandler(Task<AuthenticationState> task)
	{
		try
		{
			var authState = await task;
			isLoggedIn = authState.User.Identity?.IsAuthenticated ?? false;
			Console.WriteLine($"Auth state changed: isLoggedIn = {isLoggedIn}");

			if (isLoggedIn)
			{
				try
				{
					var profile = await AuthService.GetUserProfile();
					userName = profile?.DisplayName ?? "Spotify User";
				}
				catch (Exception ex)
				{
					Console.WriteLine($"Error getting profile after auth state change: {ex.Message}");
					userName = "Spotify User";
				}
			}
			else
			{
				userName = null;
			}

			await InvokeAsync(StateHasChanged);
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error in AuthenticationStateChangedHandler: {ex.Message}");
		}
	}



	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			try
			{
				// Check if AuthenticationService exists
				var authServiceExists = await JSRuntime.InvokeAsync<bool>("eval", "typeof AuthenticationService !== 'undefined'");

				if (authServiceExists)
				{
					await JSRuntime.InvokeVoidAsync("AuthenticationService.init");
					Console.WriteLine("AuthenticationService.init called successfully");
				}
			}
			catch (Exception ex)
			{
				Console.WriteLine($"JS Interop error: {ex.Message}");
				// Suppress the error and continue
			}
		}
	}

	public void Dispose()
	{
		try
		{
			// Clean up event handlers to prevent memory leaks
			AuthStateProvider.AuthenticationStateChanged -= AuthenticationStateChangedHandler;
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error during Dispose: {ex.Message}");
		}
	}
}

