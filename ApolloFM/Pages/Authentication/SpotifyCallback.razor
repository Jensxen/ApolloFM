@page "/spotify-callback"
@using FM.Application.Services
@using FM.Application.Services.AuthServices
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject AuthService AuthService
@inject TokenService TokenService
@inject SpotifyAuthenticationStateProvider AuthStateProvider

<div class="container mt-5">
    <div class="text-center">
        <h2>Processing Authentication...</h2>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">
                <p>@errorMessage</p>
                <button class="btn btn-primary mt-3" @onclick="ReturnHome">Return to Home</button>
            </div>
        }
        else
        {
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Please wait while we complete your authentication...</p>
        }
    </div>
</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public string State { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public string Code { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public string Error { get; set; }

    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Console.WriteLine("SpotifyCallback: OnInitializedAsync started");

            // Check for error parameter first
            if (!string.IsNullOrEmpty(Error))
            {
                errorMessage = $"Authentication error: {Error}";
                return;
            }

            // Check if we have a code parameter (required)
            if (string.IsNullOrEmpty(Code))
            {
                errorMessage = "Authorization code is missing. Please try logging in again.";
                return;
            }

            Console.WriteLine($"Callback received with code: {Code.Substring(0, Math.Min(10, Code.Length))}...");
            Console.WriteLine($"Callback received with state: {State}");

            // Validate state parameter if provided
            var storedState = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "spotify_auth_state");

            if (!string.IsNullOrEmpty(State) && !string.IsNullOrEmpty(storedState) && State != storedState)
            {
                Console.WriteLine($"State mismatch - stored: {storedState} url: {State}");
                // Log warning but continue
            }

            // Process the authorization code directly here
            try
            {
                // Use the code directly with the auth service
                await ProcessAuthCode(Code);
            }
            catch (Exception ex)
            {
                errorMessage = "Failed to process authentication. Please try again.";
                Console.Error.WriteLine($"Error processing auth code: {ex.Message}");
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error in callback: {ex.Message}");
            errorMessage = "Authentication error occurred";
            // Don't try to serialize the exception for logging
        }
    }

    private async Task ProcessAuthCode(string code)
    {
        // Method 1: Store the access token directly without making API call
        TokenService.SetAccessToken("temporary_token", 3600);

        // Update auth state
        var authProvider = (SpotifyAuthenticationStateProvider)AuthStateProvider;
        await authProvider.MarkUserAsAuthenticated("temporary_token");

        // Navigate to dashboard - this will trigger a token refresh through the normal flow
        Navigation.NavigateTo("/dashboard");
    }

    private void ReturnHome()
    {
        Navigation.NavigateTo("/");
    }
}
